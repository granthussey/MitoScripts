** This is a work in progress ** 



# MitoScripts Tutorial

In this tutorial, you'll learn how to take raw images and process them through the MitoScripts pipeline. This was written specifically for my colleagues at NYU Langone Health, but elements of it can be applicable to other use cases.

| Important Terms Cheat Sheet |  	|
|-------|----------------|
| MitoGraph 	| The program that takes z-stack .tif images and processes them into 3D models. Written by [Matheus Viana](https://sites.google.com/site/vianamp/) 	|
| MitoScripts  	|  The Python package that processes the output of MitoGraph. Written by [Grant Hussey](https://www.github.com/granthussey).	|
| z-stack | An image file (here, either .nd2, .tif, or .png) comprised of slices spaced at a certain interval |
|  gnet Files 	|   The files describing the edgelist used to produce a "graph theory" graph of your mitochondria	|
|  mitograph Files 	|   The files describing some automated outputs generated by MitoGraph	|
|  VTK Files 	|   The files describing the 3D surface, placement of nodes, placement of skeletal body	|

## Table of Contents

1. The Situation
2. Running MitoGraph
        A. Running MitoGraph via local computer
        B. Running MitoGraph via BigPurple, NYU's computing cluster
3. Using MitoScripts


# Let's MitoScripts


## 1. The Situation

### Your Experiment

In this tutorial, I will lay out an experimental protocol and provide sample data.

Let's say you're a researcher studying how chemical x and chemical y affect the mitochondrial morphology of your cells.

After doing some research, you find that MitoGraph is a robust program for analyzing your images off your microscope, and that MitoScripts is an extremely user-friendly way to run your post-MitoGraph analysis. You download both and get started.

### Your Images

First, you image your cells. You're using a spinning disk confocal microscope imaging where each image has **xy pixel sizes that are 0.0973499 um/pixel**, and **spacing between z-slices of 0.2 um**. You take note of both of these parameters for later. Your images are in the **.nd2** filetype and you save them in your `my_experiment/raw_images` folder. After imaging, you're sure to ***deconvolve*** as this is a ***critical step*** to ensure good MitoGraph output. You save these into `my_experiment/deconvolve`.

| Lab Notebook 	| |
|-------|----------------|
| xy pixel size | 0.0973499 um/pixel |
| z-spacing | 0.2 um |

```
my_experiment
├── raw_images
│   ├── control000.nd2
│   ├── control001.nd2
│   ├── control002.nd2
│   ├── chem_x_000.nd2
│   ├── chem_x_001.nd2
│   ├── chem_x_002.nd2
│   ├── chem_y_000.nd2
│   ├── chem_y_001.nd2
│   └── chem_y_002.nd2
│
└── deconvolve
    ├── control000.nd2
    ├── control001.nd2
    ├── control002.nd2
    ├── chem_x_000.nd2
    ├── chem_x_001.nd2
    ├── chem_x_002.nd2
    ├── chem_y_000.nd2
    ├── chem_y_001.nd2
    └── chem_y_002.nd2
```

```
my_experiment
├── raw_images
│   └── __init__.cpython-37.pyc
└── mitoscripts
    ├── LICENSE
    ├── __init__.py
    ├── __pycache__
    │   ├── __init__.cpython-37.pyc
    │   ├── mitodata.cpython-37.pyc
    │   └── mitographer.cpython-37.pyc
    ├── mitodata.py
    ├── mitographer.py
    └── mitopca.py
```

## 2. Running MitoGraph

First, we must preprocess our images for MitoGraph. *Goal:* Take your .nd2 images, make them into .tif, then crop out individual cells from each image.

**1. Change your files to .nd2 files, use MaxProj.tif to crop cells**

To do this, simply use the **Tiff_and_MaxProjs.ijm** macro, pointing it to your ***deconvolved .nd2 file directory***. This will produce .tif files in its new directory, as well as an image called *MaxProj.tif*. More on that in a minute. For now, you should have the following files:

```
my_experiment
├── raw_images
│   ├── control000.nd2
│   ├── control001.nd2
│   ├── control002.nd2
│   ├── chem_x_000.nd2
│   ├── chem_x_001.nd2
│   ├── chem_x_002.nd2
│   ├── chem_y_000.nd2
│   ├── chem_y_001.nd2
│   └── chem_y_002.nd2
│
└── deconvolve
    │   └── TiffFiles
    │       ├── control000.tif
    │       ├── control001.tif
    │       ├── control002.tif
    │       ├── chem_x_000.tif
    │       ├── chem_x_001.tif
    │       ├── chem_x_002.tif
    │       ├── chem_y_000.tif
    │       ├── chem_y_001.tif
    │       ├── chem_y_002.tif
    │       └── MaxProj.tif
    ├── control000.nd2
    ├── control001.nd2
    ├── control002.nd2
    ├── chem_x_000.nd2
    ├── chem_x_001.nd2
    ├── chem_x_002.nd2
    ├── chem_y_000.nd2
    ├── chem_y_001.nd2
    └── chem_y_002.nd2
```

Since this list is getting a little lengthy, I'm going to shorten it like so:

```
my_experiment
├── raw_images
│   ├── control000.nd2
│   ├── ...
│   └── chem_y_002.nd2
│
└── deconvolve
    │   └── TiffFiles
    │       ├── control000.tif
    │       ├── ...
    │       ├── chem_y_002.tif
    │       └── MaxProj.tif
    ├── control000.nd2
    ├── ...
    └── chem_y_002.nd2
```

Now that we have the .tif files, we need to crop out each individal cell. To do this, we'll use MaxProj to automate the process. MaxProj is an image that has one z-slice for each image to analyze (control000.tif ... chem_y_002.tif, total of 9 images). It was automatically made when we transfered our .nd2 files to .tif.

Open MaxProj.tif and press "t" or otherwise open the "ROI Manager". Use this to define ROI by the polygon or lasso tool. After you complete circling the cells, select all of the line items in your ROI Manager and save these to your 'TiffFiles' directory as "ROISet.zip" (the default name).

```
my_experiment
├── raw_images
│   ├── control000.nd2
│   ├── ...
│   └── chem_y_002.nd2
│
└── deconvolve
    │   └── TiffFiles
    │       ├── control000.tif
    │       ├── ...
    │       ├── chem_y_002.tif
    │       ├── MaxProj.tif
    │       └── ROISet.zip                  # Here's your ROISet.zip!
    ├── control000.nd2
    ├── ...
    └── chem_y_002.nd2
```

Next, run *CropCells_Complete.ijm* on your 'TiffFiles' directory. It will use the *MaxProj.tif* file and *ROISet.zip* to crop out cells and place each in ***its own folder***. This is important to keep in mind. **Since we will only work in the 'TiffFiles' directory from now on, I will only display that in the following diagrams.**

```
TiffFiles
├── NoGauss
│      ├── control000_000   # Contains control000's cropped-cell image
│      ├── ...
│      └── chem_y_002_008   # Contains chem_y_002's cropped-cell image
├── control000.tif
├── ...
├── chem_y_002.tif
├── MaxProj.tif
└── ROISet.zip                  
```

 As you can see, a new folder, ***NoGauss***, was created. This directory is a directory of directories - it contains one folder for each cell it cropped. Look closely and you'll see a ***new set of three numbers*** appended onto the end of each directory. This is a unique identifier for the cell and created because you have more than one cell per image.

 Why *NoGauss*? There is actually an option here. When cropping the cells, you can opt to fill the white background around the cell with Gaussian noise. This may lessen MitoGraph artifacts later. Personally, not adding this noise has given me better results, so I don't use it. *To use Gauss and NoGauss options, simply follow the instructions within CropCells_Complete.ijm*. 

Now that we have 1) made our .nd2 files .tif, 2) cropped our cells and put them in proper folders, we're ready to use MitoGraph.


**2. Run MitoGraph**

There are two ways to do this: either run MitoGraph locally, or run MitoGraph on BigPurple, NYU's computing cluster.

To run MitoGraph locally, you'll need MacOS 10.10 or higher. On BigPurple, it'll be easy to run MitoGraph and then bring its output to your computer regardless of OS.

### **Run Locally**

The first thing you need to do is to move all of the .tif files from being contained within their own folders to being in only one folder. To do this, simply create a new folder called "Batch" in your `TiffFiles` directory and use the command:

``` find ~/my_experiment/TiffFiles/NoGauss -type f -print0 | xargs -0 cp -t ~/my_experiment/TiffFiles/Batch ```

This will copy all files from each individual folder recursively to the new `Batch` folder. This results in:

```
TiffFiles
├── NoGauss
│      ├── control000_000   
│      ├── ...
│      └── chem_y_002_008   
├── Batch
│      ├── control000_000.tif   # This is actually the file! Not a directory.
│      ├── ...
│      └── chem_y_002_008.tif   # This is actually the file! Not a directory.
├── control000.tif
├── ...
├── chem_y_002.tif
├── MaxProj.tif
└── ROISet.zip                  
```

Next, you want to point MitoGraph to that folder. First, download the latest version of [MitoGraph](https://github.com/vianamp/MitoGraph). In this tutorial, I'll ask you to place it within the `TiffFiles` directory, but you could very well place it anywhere, just be sure you know where you put it. 

```
TiffFiles
├── MitoGraph           # This is a binary file!
├── NoGauss
│      ├── control000_000   
│      ├── ...
│      └── chem_y_002_008   
├── Batch
│      ├── control000_000.tif   
│      ├── ...
│      └── chem_y_002_008.tif   
├── control000.tif
├── ...
├── chem_y_002.tif
├── MaxProj.tif
└── ROISet.zip                  
```

Now, open the terminal and navigate so that TiffFiles in your current working directory. Then, run MitoGraph using the following command:

``` MitoGraph -xy 0.0973499 -z 0.2 -scales 1.0 1.3 4 -adaptive 10 -path ./Batch ```

Notice that the -xy flag requires your xy pixel size, and that the -z flag requires the z-spacing, both we remember from Part 1. 

After MitoGraph runs, your `Batch` directory will be a little more full. You should have **eight** files per image, so you should have a total of **sixty-four** files in the `Batch` directory. 

Now you're ready to use MitoScripts. 

### **Run on Big Purple**

Using the remote server has its upsides, like 1) you can run this regardless of your local machine's operating system, and 2) the provided batch scripts disbatches your jobs in parallel so they run a lot faster. But it is more involved. 

First, you need to configure your `scratch` directory on BigPurple. Make it so that your `gpfs/scratch/your_name` has the following two folders:

```
/gpfs/scratch/your_name
├── Data          
└── Results
```

Next, upload your `NoGauss` folder to the `Data` folder.

```
/gpfs/scratch/your_name
├── Data     
│      └── NoGauss   
│         ├── control000_000   
│         ├── ...
│         └── chem_y_002_008    
└── Results
```

Now, change the name of your `NoGauss` directory to something more descriptive.

```
/gpfs/scratch/your_name
├── Data     
│      └── 09May2020_Chemicals   
│         ├── control000_000   
│         ├── ...
│         └── chem_y_002_008    
└── Results
```

We named it *09May2020_Chemicals* because we completed the experiment on May 9, 2020 and because in this experiment we're interested in the effects of chemical x and y on mitochondrial morphology.

Next, you'll need to get ready to submit a batch job. First, download MitoGraph build for the BigPurple RedHat operating system (within this folder). Next, upload that into your home directory (***not your scratch directory***) like so:

```
/gpfs/home/your_name
├── bin     
│      └── MitoGraph                # Make sure this is the MitoGraph from my GitHub built for RedHat.   
│
└── Whatever else you got in your home!
```

`bin` stands for binary and is where you should keep your binary files. Additionally, make a `scripts` folder and place the two scripts provided from this GitHub: `ini_mitograph.sh` and `run_mitograph.sh`.

You'll be using `ini_mitograph.sh` to submit your jobs, *so this is the only shell script you'll interface with*. It will use `run_mitograph.sh` in the process.

Now we need to edit two parts of `ini_mitograph.sh`. First, the variable `USER` on line 31 to your own name ID. Make sure there is no spaces anywhere. Second, change line 66 from `~/MitoScripts/Shell/run_mitograph.sh` to `~/scripts/run_mitograph.sh` or wherever you placed MitoGraph.

Now you're ready to run. As a final check, make sure your data is placed properly on the server:

```
/gpfs/home/your_name
├── bin     
│      └── MitoGraph                
├── scripts     
│      ├── ini_mitograph.sh    # Make sure you're made the changes to line 31 and line 66!   
│      └── run_mitograph.sh               
│
└── Whatever else you got in your home!
```

```
/gpfs/scratch/your_name
├── Data     
│      └── 09May2020_Chemicals   
│         ├── control000_000   
│         ├── ...
│         └── chem_y_002_008    
└── Results
```

Now run by the following command:

``` sbatch ~/scripts/ini_mitograph.sh /gpfs/scratch/your_name/Data/09May2020_Chemicals ```

Check on the status of your jobs with `squeue -u your_name` and if something goes wrong, use `scancel -u your_name` to cancel all jobs you're initiated (**be careful, including jobs you started before this tutorial**).

When everything's finished, the script should have made some new folders in your `/gpfs/scratch/your_name/Results` directory with the results.

```
/gpfs/scratch/your_name
├── Data     
│      └── 09May2020_Chemicals   
│         ├── control000_000   
│         ├── ...
│         └── chem_y_002_008    
└── Results
          ├── Batch        # This contains all of your .tif files 
          ├── Orig         # This contains a carbon copy of the folder MitoGraph ran on
          └── Segmented    # This contains a directory of directories each containing 8 files, your .tif original image and 7 outputs from MitoGraph 
```

Now you have your MitoGraph outputs: your original .tif file, and 7 mitograph output files. Move all of these into a single directory by:

``` 
mkdir /gpfs/scratch/your_name/Results/All_The_Results
find /gpfs/scratch/your_name/Results/Segmented -type f -print0 | xargs -0 cp -t /gpfs/scratch/your_name/Results/All_The_Results
```

I've named it `All_The_Results`, which is a p bad name. Adjust this as needed.

Now you're ready to use MitoScripts. 

## 3. Using MitoScripts

Regardless of how you got there, now you have your MitoGraph outputs: your original .tif file, and 7 mitograph output files. Move all of these into a single directory and let's get cooking.

First, make sure you have MitoGraph installed. It is currently available via `pip`. 

`pip install mitoscripts`

Make sure you have the latest version.

To use MitoScripts, you only need the .gnet and .mitograph files. Be sure these are intact in your data directory.


