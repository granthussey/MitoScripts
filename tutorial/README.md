** This is a work in progress ** 

> Steps 1 and 2 are mostly finished. Step 3 is mostly unwritten.

> Send any questions to `grant.hussey@nyulangone.org` with "MitoScripts" somewhere in the subject line.


# MitoScripts Tutorial

In this tutorial, you'll learn how to take raw images and process them through the MitoScripts pipeline. **The first two parts** of the tutorial were written specifically for my colleagues at NYU Langone Health needing to use MitoGraph in a high-thouroughput manner on our computing cluster. **Part three** ***is universally applicable to all users of MitoGraph who wish to add MitScripts into a streamlined post-MitoGraph pipeline.*** I've provided sample data (.gnet and .mitograph files) in this directory for those who skip to Step 3.

| Important Terms Cheat Sheet |  	|
|-------|----------------|
| MitoGraph 	| The program that takes z-stack .tif images and processes them into 3D models. Written by [Matheus Viana](https://sites.google.com/site/vianamp/) 	|
| MitoScripts  	|  The Python package that processes the output of MitoGraph. Written by [Grant Hussey](https://www.github.com/granthussey).	|
|  gnet Files 	|   The files describing the edgelist used to produce a "graph theory" graph of your mitochondria	|
|  mitograph Files 	|   The files describing some automated outputs generated by MitoGraph	|

&nbsp;

# Table of Contents

MitoScripts is a package to process the output of MitoGraph. Thus, I will first briefly explain the MitoGraph pipeline before detailing how to use MitoScripts.

**Steps 1 and 2** are written for my colleagues at NYU Langone Health, but parts can still be applicable to the general public. **Step 3** is written for a larger audience who wish to have a detailed look at what MitoScripts can do. 

&nbsp;
&nbsp;

***For my colleages:***
### 1. **The Situation:** Experimental Setup
### 2. **Running MitoGraph:** Locally and on BigPurple

&nbsp;

***For the general public:***
### 3. **Using MitoScripts:** What to do with your MitoGraph output files

&nbsp;

# Let's MitoScripts


## **1. The Situation**

### **Your Experiment**

In this tutorial, I will lay out an experimental protocol and provide sample data.

Let's say you're a researcher studying how chemical x and chemical y affect the mitochondrial morphology of your cells.

After doing some research, you decide to use MitoGraph to analyze your images off the scope, and also decide that MitoScripts is an extremely user-friendly way to run your post-MitoGraph analysis. You download both and get started.

### **Your Images**

First, you image your cells. You're using a spinning disk confocal microscope where each image is a z-stack with **spacing between z-slices at 0.2 um** and **xy pixel size at 0.0973499 um/pixel**. You take note of this for later. Your images are in the **.nd2** filetype and you save them in your `my_experiment/raw_images` folder. After imaging, you're sure to ***deconvolve*** as this is a ***critical step*** to ensure good MitoGraph output. You save these into `my_experiment/deconvolve`.

| Lab Notebook 	| |
|-------|----------------|
| xy pixel size | 0.0973499 um/pixel |
| z-spacing | 0.2 um |

```
my_experiment               # This folder is downloadable in this GitHub repository!
├── raw_images
│   ├── control000.nd2
│   ├── control001.nd2
│   ├── control002.nd2
│   ├── chem_x_000.nd2
│   ├── chem_x_001.nd2
│   ├── chem_x_002.nd2
│   ├── chem_y_000.nd2
│   ├── chem_y_001.nd2
│   └── chem_y_002.nd2
│
└── deconvolve
    ├── control000.nd2
    ├── control001.nd2
    ├── control002.nd2
    ├── chem_x_000.nd2
    ├── chem_x_001.nd2
    ├── chem_x_002.nd2
    ├── chem_y_000.nd2
    ├── chem_y_001.nd2
    └── chem_y_002.nd2
```

## 2. Running MitoGraph

> **Dear Colleagues:** This is meant as additional help after you read the [original MitoGraph paper](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6322684/). First become comfortable with that paper (and maybe play around a bit with its methodology) before attempting this tutorial.

First, we must preprocess our images for MitoGraph. *Goal:* Take your .nd2 images, make them into .tif, then crop out individual cells from each image.

&nbsp;

### **1. Change your files to .nd2 files, use MaxProj.tif to crop cells**

To do this, simply use the **Tiff_and_MaxProjs.ijm** macro, pointing it to your ***deconvolved .nd2 file directory***. This will produce .tif files in a new directory, as well as an image called *MaxProj.tif*. The *MaxProj.tif* file will be used to automate cropping each cell out of the larger image. For now, you should have the following files:

```
my_experiment
├── raw_images
│   ├── control000.nd2
│   ├── control001.nd2
│   ├── control002.nd2
│   ├── chem_x_000.nd2
│   ├── chem_x_001.nd2
│   ├── chem_x_002.nd2
│   ├── chem_y_000.nd2
│   ├── chem_y_001.nd2
│   └── chem_y_002.nd2
│
└── deconvolve
    │   └── TiffFiles               # Here are your tif's!
    │       ├── control000.tif
    │       ├── control001.tif
    │       ├── control002.tif
    │       ├── chem_x_000.tif
    │       ├── chem_x_001.tif
    │       ├── chem_x_002.tif
    │       ├── chem_y_000.tif
    │       ├── chem_y_001.tif
    │       ├── chem_y_002.tif
    │       └── MaxProj.tif         # Here is your MaxProj.tif
    ├── control000.nd2
    ├── control001.nd2
    ├── control002.nd2
    ├── chem_x_000.nd2
    ├── chem_x_001.nd2
    ├── chem_x_002.nd2
    ├── chem_y_000.nd2
    ├── chem_y_001.nd2
    └── chem_y_002.nd2
```

Since this list is getting a little lengthy, I'm going to shorten it like so:

```
my_experiment
├── raw_images
│   ├── control000.nd2
│   ├── ...
│   └── chem_y_002.nd2
│
└── deconvolve
    │   └── TiffFiles               # Here are your tif's!
    │       ├── control000.tif
    │       ├── ...
    │       ├── chem_y_002.tif
    │       └── MaxProj.tif         # Here is your MaxProj.tif
    ├── control000.nd2
    ├── ...
    └── chem_y_002.nd2
```

Now that we have the .tif files, we need to crop out each individal cell. To do this, we'll use MaxProj to automate the process. MaxProj is an image comprised of one z-slice for each image to analyze (control000.tif ... chem_y_002.tif, total of 9 images, thus *MaxProj.tif* is a 9-slice z-stack). It was automatically made when we converted our .nd2 files to .tif using the **Tiff_and_MaxProjs.ijm** macro.

Open MaxProj.tif and press "t", or otherwise open the "ROI Manager". Use this to define ROI on each slice by the polygon or lasso tool. After you complete circling the cells, select all of the line items in your ROI Manager and save these to your 'TiffFiles' directory as "ROISet.zip" (the default name).

```
my_experiment
├── raw_images
│   ├── control000.nd2
│   ├── ...
│   └── chem_y_002.nd2
│
└── deconvolve
    │   └── TiffFiles
    │       ├── control000.tif
    │       ├── ...
    │       ├── chem_y_002.tif
    │       ├── MaxProj.tif
    │       └── ROISet.zip                  # Here's your ROISet.zip!
    ├── control000.nd2
    ├── ...
    └── chem_y_002.nd2
```

Next, run *CropCells_Complete.ijm* on your 'TiffFiles' directory. It will use  *MaxProj.tif*  and *ROISet.zip* to crop out cells and place each in ***its own folder***. This is important to run MitoGraph on our compute cluster, BigPurple. **Since we will only work in the 'TiffFiles' directory from now on, I will only display it and its child directories in the following diagrams.**

```
TiffFiles
├── NoGauss
│      ├── control000_000   # Contains control000's cropped-cell image
│      │   └── control000_000.tif 
│      ├── ...
│      └── chem_y_002_008   # Contains chem_y_002's cropped-cell image
│          └── chem_y_002_008.tif 
├── control000.tif
├── ...
├── chem_y_002.tif
├── MaxProj.tif
└── ROISet.zip                  
```

 As you can see, a new folder, ***NoGauss***, was created. This directory is a directory of directories - it contains one folder for each cell it cropped. Look closely and you'll see ***a set of three numbers*** appended onto the end of each directory. This is a unique identifier for the cell. *CropCells_Complete.ijm* added this because it is possible to have more than one cell per image.

 Why is it named *NoGauss*? When cropping the cells, you can opt to fill the white background around the cell with Gaussian noise. This may lessen MitoGraph artifacts later. Personally, not adding this noise has given me better results, so I don't use it. But I encourage you to try both adding Gaussian noise and not adding Gaussian noise. *To use Gauss and NoGauss options, simply follow the instructions within CropCells_Complete.ijm. Briefly, you need to comment out the function calls for the method you do not wish to use.* 

Now that we have 1) converted our .nd2 files to .tif files, and 2) cropped each cell into its own respective folder, we're ready to use MitoGraph.

&nbsp;

### **2. Run MitoGraph**

> ***For those reading outside of NYU Langone Health:*** Obviously, the section "*Option 1:* Run on BigPurple" wont be applicable to you unless you wish to create a similar pipeline on your own compute clusters. But "*Option 2:* Run Locally" is possible if you have access to a Mac, or recompile MitoGraph for your respective OS.

You can either run MitoGraph via BigPurple or locally on your own machine. There are pros/cons to each. 

*Short version:* 
To run MitoGraph locally, you'll need MacOS 10.10 or higher. On BigPurple, you can run MitoGraph regardless of operating system before downloading its output to your local machine for post-processing with MitoScripts, which is an OS-independent Python package. Running on BigPurple is also generally faster.

*Long version:*

The biggest difference is time. Running MitoGraph on BigPurple is significantly faster since you can easily parallelize. The provided Shell scripts on this GitHub repo dispatch a new job for each folder containing one image - this means that an instance of MitoGraph is initialized for each image, so processing 100 images can theoretically take only as much time as running 1 image. If you run MitoGraph locally, it will process each image sequentially, so running many images could take overnight.

Another difference is operating system. MitoGraph is a compiled binary file compatable with MacOS 10.10 or higher. To use on a different operating system, you need to download the source code and re-compile for your own operating system. (I've done this for BigPurple's RedHat distribution.) Thus, if you don't have MacOS, you may be forced to use BigPurple unless you take the time to re-compile MitoGraph.

### **3. *Option 1:* Run on BigPurple**

First, you need to configure your `scratch` directory on BigPurple. Make it so that your `gpfs/scratch/your_name` has the following two folders:

```
/gpfs/scratch/your_name
├── Data          
├── Results
└── ...

```

Where "..." designates any other existing folders. Next, upload your `NoGauss` folder to the `Data` folder. (Either use a GUI-based software like [Filezilla](https://filezilla-project.org) or via the command line with `scp`.)

```
/gpfs/scratch/your_name
├── Data     
│      └── NoGauss   
│         ├── control000_000   # remember, this is a folder with its respective image.
│         ├── ...
│         └── chem_y_002_008   # and so is this folder
├── Results
└── ...
```

Now, change the name of the `NoGauss` directory to something more descriptive.

```
/gpfs/scratch/your_name
├── Data     
│      └── 09May2020_Chemicals  # Here's the new, descriptive name!
│         ├── control000_000   
│         ├── ...
│         └── chem_y_002_008    
├── Results
└── ...
```

We named it *09May2020_Chemicals* because we completed this hypothetical experiment on May 9, 2020 and because in this experiment we're interested in the effects of chemical x and y on mitochondrial morphology.

Next, you'll need to get ready to submit a batch job. First, download MitoGraph built for BigPurple RedHat operating system. Then, upload that into your home directory (***not your scratch directory***) like so:

```
/gpfs/home/your_name                # This is NOT your scratch - this is your home folder: "~/"
├── bin     
│      └── MitoGraph                # Make sure this is the MitoGraph from my GitHub built for RedHat.   
│
└── ...
```

`bin` stands for binary and is where you should keep your binary files. Next, make a `scripts` folder and place the two scripts provided from this GitHub: `ini_mitograph.sh` and `run_mitograph.sh`.

You'll be using `ini_mitograph.sh` to submit your jobs. *This is the only shell script you'll interface with*. `ini_mitograph.sh` uses `run_mitograph.sh`, so you still need both.

Now the hardest part: **we need to edit two parts of `ini_mitograph.sh`**. First, edit the variable `USER` on line 31 to your own name ID. Make sure there are no spaces between USER, =, and your_name -- it should end up in the form `USER=bh1562` or `USER=jc3581`, for example. Second, change line 66 from `~/MitoScripts/Shell/run_mitograph.sh` to `~/scripts/run_mitograph.sh` or wherever you placed MitoGraph.

Now you're ready to run. As a final check, make sure your data is placed properly on the server:

```
/gpfs/home/your_name           # Your home directory
├── bin     
│      └── MitoGraph                
├── scripts     
│      ├── ini_mitograph.sh    # Make sure you're made the changes to line 31 and line 66!   
│      └── run_mitograph.sh               
│
└── ...
```

```
/gpfs/scratch/your_name        # Your scratch directory
├── Data     
│      └── 09May2020_Chemicals   
│         ├── control000_000   
│         ├── ...
│         └── chem_y_002_008    
├── Results
└── ...
```

Now run MitoGraph via the following command:

``` sbatch ~/scripts/ini_mitograph.sh /gpfs/scratch/your_name/Data/09May2020_Chemicals ```

This (1) starts your batch job but also (2) gives `ini_mitograph.sh` an arguement, `gpfs/scratch/your_name/Data/09May2020_Chemicals`, which is where your unprocessed data resides. For other experiments, point `ini_mitograph.sh` to the proper directory by changing the above command.

Check on the status of your jobs with `squeue -u your_name` and if something goes wrong, use `scancel -u your_name` to cancel all jobs you're initiated (**be careful, this cancels all of your jobs, including those you started before this tutorial**).

> Log files will be created in your working directory of the time you submitted your current working directory. Check these for any "Segmentation error."

When everything's finished, the script should have made some new folders in your `/gpfs/scratch/your_name/Results` directory with the results.

```
/gpfs/scratch/your_name
├── Data     
│      └── 09May2020_Chemicals   
│         ├── control000_000   
│         ├── ...
│         └── chem_y_002_008    
└── Results
          ├── Batch        # This contains all of your .tif files 
          ├── Orig         # This contains a carbon copy of the folder MitoGraph ran on, for bug testing purposes
          └── Segmented    # This is a directory of directories, each each containing 9 files, your .tif original image and 8 outputs from MitoGraph 
              ├── control000_000 
              │   ├── control000_000_mitosurface.vtk 
              │   ├── control000_000_nodes.vtk
              │   ├── control000_000_skeleton.vtk
              │   ├── control000_000.coo
              │   ├── control000_000.gnet           # MitoScripts uses these
              │   ├── control000_000.mitograph      # MitoScripts uses these
              │   ├── control000_000.tif      
              │   ├── control000_000.png      
              │   └── control000_000.txt     
              ├── ...
              └── chem_y_002_008    
                  ├── chem_y_002_008_mitosurface.vtk 
                  ├── chem_y_002_008_nodes.vtk
                  ├── chem_y_002_008_skeleton.vtk
                  ├── chem_y_002_008.coo
                  ├── chem_y_002_008.gnet           # MitoScripts uses these
                  ├── chem_y_002_008.mitograph      # MitoScripts uses these
                  ├── chem_y_002_008.tif      
                  ├── chem_y_002_008.png      
                  └── chem_y_002_008.txt     
```

Now you have your MitoGraph outputs: your original .tif file, and 8 mitograph output files. Move all of these into a single directory called all_the_results by:

``` 
mkdir /gpfs/scratch/your_name/Results/all_the_results
find /gpfs/scratch/your_name/Results/Segmented -type f -print0 | xargs -0 cp -t /gpfs/scratch/your_name/Results/all_the_results
```

I've named it `all_the_results`, which is a boring name. Adjust this as needed.

Now you're ready to use MitoScripts. 

&nbsp;

### **3. *Option 2:* Run Locally**

First, move all of the files from their own respective folders to one shared folder. To do this, simply create a new folder called "Batch" in your `TiffFiles` directory and use the command:

``` find ~/my_experiment/TiffFiles/NoGauss -type f -print0 | xargs -0 cp -t ~/my_experiment/TiffFiles/Batch ```

This will copy all files from each individual folder recursively to the new `Batch` folder. FYI, you'll need to edit that command with your specific originating/destination folders as your filepath may be different. After running, the command results in:

```
TiffFiles
├── NoGauss
│      ├── control000_000   
│      ├── ...
│      └── chem_y_002_008   
├── Batch
│      ├── control000_000.tif   # This is actually the file! Not a directory.
│      ├── ...
│      └── chem_y_002_008.tif   # This is actually the file! Not a directory.
├── control000.tif
├── ...
├── chem_y_002.tif
├── MaxProj.tif
└── ROISet.zip                  
```

Next, you want to point MitoGraph to that folder. First, download the latest version of [MitoGraph](https://github.com/vianamp/MitoGraph). In this tutorial, I'll ask you to place it within the `TiffFiles` directory, but you could very well place it anywhere, just be sure you know where you put it. 

```
TiffFiles
├── MitoGraph           # This is a binary file!
├── NoGauss
│      ├── control000_000   
│      ├── ...
│      └── chem_y_002_008   
├── Batch
│      ├── control000_000.tif   
│      ├── ...
│      └── chem_y_002_008.tif   
├── control000.tif
├── ...
├── chem_y_002.tif
├── MaxProj.tif
└── ROISet.zip                  
```

Now, open the terminal and navigate so that TiffFiles in your current working directory. Then, run MitoGraph using the following command:

``` MitoGraph -xy 0.0973499 -z 0.2 -scales 1.0 1.3 4 -adaptive 10 -path ./Batch ```

Notice that the -xy flag requires your xy pixel size, and that the -z flag requires the z-spacing, both we remember from Part 1. 

After MitoGraph runs, your `Batch` directory will have 9 files per original image,   so you should have a total of **seventy-two** files in the `Batch` directory. 

Now you're ready to use MitoScripts. 

&nbsp;

## 3. Using MitoScripts

Regardless of how you got there, now you have your MitoGraph outputs: your original .tif file, and 8 mitograph output files. Move all of these into a single directory and let's get cooking. **You'll only need the .gnet and .mitograph files, so feel free to leave the rest on the server or in the original folder.**

First, make sure you have MitoGraph installed. It is currently available via `pip`. 

`pip install mitoscripts`

Make sure you have the latest version.

To use MitoScripts, you only need the .gnet and .mitograph files. Be sure these are intact in your data directory.


